<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.oti.thirtyone.dao.NoticeDao">

	<insert id="noticeWrite" parameterType="Notice">
		<selectKey keyProperty="noticeId" resultType="int"
			order="BEFORE">
			SELECT NOTICES_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO NOTICES(
		NOTICE_ID, NOTICE_TITLE, NOTICE_CONTENT, NOTICE_DATE, NOTICE_HIT_COUNT,
		NOTICE_IMPORTANT, NOTICE_ALL_TARGET, NOTICE_DELETED, EMP_ID)
		VALUES(
		#{noticeId}, #{noticeTitle}, #{noticeContent}, sysdate, 0,
		#{noticeImportant}, #{noticeAllTarget}, #{noticeDeleted}, #{empId}
		)
	</insert>

	<insert id="insertNoticeFile" parameterType="NoticeFile">
		<selectKey keyProperty="noticeFileId" resultType="int"
			order="BEFORE">
			SELECT NOTICE_FILES_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO NOTICE_FILES (
		NOTICE_FILE_ID, NOTICE_FILE_NAME, NOTICE_FILE_DATA, NOTICE_FILE_TYPE, NOTICE_ID)
		VALUES (
		#{noticeFileId}, #{noticeFileName}, #{noticeFileData}, #{noticeFileType}, #{noticeId})
	</insert>
	
	<select id="selectListPager" parameterType="Pager" resultType="Notice">
		<![CDATA[		
			SELECT ROWNUM AS RNUM, NOTICE_ID, NOTICE_TITLE, NOTICE_DATE, NOTICE_HIT_COUNT, NOTICE_IMPORTANT, EMP_ID
			FROM (
				SELECT ROWNUM AS RNUM, NOTICE_ID, NOTICE_TITLE, NOTICE_DATE, NOTICE_HIT_COUNT, NOTICE_IMPORTANT, EMP_ID
				FROM (
					SELECT NOTICE_ID, NOTICE_TITLE, NOTICE_DATE, NOTICE_HIT_COUNT, NOTICE_IMPORTANT, EMP_ID
					FROM NOTICES
			        ORDER BY (CASE WHEN NOTICE_IMPORTANT = '1' THEN 1 ELSE 2 END), NOTICE_ID DESC
		        )
				WHERE ROWNUM <= #{endRowNo}
			)
			WHERE RNUM >= #{startRowNo}	
		
		]]>		
	</select>
	
	<select id="searchNotice" parameterType="String" resultType="Notice">
		SELECT *
		FROM NOTICES
		WHERE NOTICE_TITLE LIKE '%'||#{noticeTitle}||'%'
		ORDER BY (CASE WHEN NOTICE_IMPORTANT = '1' THEN 1 ELSE 2 END), NOTICE_ID DESC
	</select>
	
	<select id="countRows" parameterType="int">
		SELECT COUNT (*)
		FROM NOTICES
	</select>
	
	<select id="selectByNoticeId" parameterType="int" resultType="Notice">
		SELECT * FROM NOTICES
		WHERE NOTICE_ID = #{noticeId}	
	</select>

	<select id="selectAttachByNoticeId" parameterType="int" resultType="NoticeFile">
		SELECT * FROM NOTICE_FILES
		WHERE NOTICE_FILE_ID = #{noticeFileId}	
	</select>

	<select id="selectAttachFiles" parameterType="int" resultType="NoticeFile">
		SELECT * FROM NOTICE_FILES
		WHERE NOTICE_ID = #{noticeId}	
	</select>
	
	<select id="prevNext" resultType="Notice">
		SELECT * FROM (SELECT NOTICE_ID, NOTICE_TITLE,
		LAG(NOTICE_ID, 1, 0) OVER(ORDER BY NOTICE_ID) PREVNUM,
		LAG(NOTICE_TITLE, 1, '이전글이 없습니다') OVER(ORDER BY NOTICE_ID) PREVTITLE,
		
		LEAD(NOTICE_ID, 1, 0) OVER(ORDER BY NOTICE_ID) NEXTNUM,
		LEAD(NOTICE_TITLE, 1, '다음글이 없습니다') OVER(ORDER BY NOTICE_ID) NEXTTITLE
		FROM NOTICES) WHERE NOTICE_ID=#{noticeId} ORDER BY NOTICE_ID
	</select>
	
	<update id="updateNotice" parameterType="Notice">
		UPDATE NOTICES SET
			NOTICE_TITLE = #{noticeTitle},
			NOTICE_CONTENT = #{noticeContent},
			NOTICE_DATE = sysdate,
			NOTICE_IMPORTANT = #{noticeImportant},
			NOTICE_ALL_TARGET = #{noticeAllTarget}		
		WHERE NOTICE_ID = #{noticeId}
	</update>
	
	<update id="updateNoticeFile" parameterType="NoticeFile">
		UPDATE NOTICE_FILES SET
			<if test="noticeFileName != null">
				NOTICE_FILE_NAME = #{noticeFileName},
				NOTICE_FILE_TYPE = #{noticeFileType},
				NOTICE_FILE_DATA = #{noticeFileData}
			</if>
		WHERE NOTICE_ID = #{noticeId}	
	</update>
	
	<update id="updateHitCount" parameterType="int">
		UPDATE NOTICES SET
			NOTICE_HIT_COUNT = NOTICE_HIT_COUNT + 1
		WHERE NOTICE_ID = #{noticeId}		
	</update>
	
	<delete id="deleteNoticeFile" parameterType="int">
		DELETE FROM NOTICE_FILES
		WHERE NOTICE_ID = #{noticeId}
	</delete>

	<delete id="deleteNotice" parameterType="int">
		DELETE FROM NOTICES
		WHERE NOTICE_ID = #{noticeId}	
	</delete>
	
	<delete id="deleteFile" parameterType="int">
		DELETE FROM NOTICE_FILES
		WHERE NOTICE_FILE_ID = #{noticeFileId}
	</delete>
	
	<insert id="insertNoticeTarget" parameterType="Notice">
	    <foreach collection="deptId" item="deptId" separator=";">
	        INSERT INTO NOTICE_TARGET (NOTICE_ID, DEPT_ID)
	        VALUES (#{noticeId}, #{deptId})
	    </foreach>
	</insert>





</mapper>