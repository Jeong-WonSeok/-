<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.oti.thirtyone.dao.ReasonDao">
	<insert id="insertReason" parameterType="Reason">
		<selectKey keyProperty="reason.reasonId" resultType="int" order="BEFORE">
			select reason_seq.nextval from dual
		</selectKey>
		insert into reason
		(
			reason_id, reason_type, reason_content, reason_status,
			atd_date, emp_id, reason_improver
		) values (
			#{reason.reasonId}, #{reason.reasonType}, #{reason.reasonContent}, '대기',
			( select atd_date from attendances
		 		where to_char(atd_date, 'yyyy-mm-dd') = #{day} and emp_id=#{reason.empId} ), 
		 	#{reason.empId}, #{reason.reasonImprover}
		)
	</insert>
	
	<select id="selectReasonNum" resultType="int">
		select count(reason_id)
		from reason
		where emp_id = #{empId} and to_char(atd_date, 'yyyy-mm-dd') = #{day}
	</select>
	
	<select id="selectReasonListByImprover" resultType="Reason">
		<![CDATA[	
			select reason_id, reason_type, reason_content, reason_status,
				atd_date, emp_id, reason_improver
			from (
				select rownum as rnum, reason_id, reason_type, reason_content, reason_status,
					atd_date, emp_id, reason_improver
				from (
					select reason_id, reason_type, reason_content, reason_status,
						atd_date, emp_id, reason_improver
					from reason
					where reason_improver = #{empId} and reason_status = '대기'
					order by atd_date				
				)
				where rownum <= #{pager.endRowNo}
			)
			where rnum >= #{pager.startRowNo}
		]]>
	</select>
	
	<select id="countRowsByImprover" parameterType="String" resultType="int">
		select count(reason_id)
		from reason
		where reason_improver = #{empId}
	</select>
	
	<select id="selectReason" parameterType="int" resultType="Reason">
		select reason_id, reason_type, reason_content, reason_status,
			atd_date, emp_id, reason_improver
		from reason
		where reason_id = #{reasonId}	
	</select>
	
	<update id="updateReasonStatus" parameterType="int">
		update reason 
		set reason_status = '승인'
		where reason_id = #{reasonId} 
	</update>
</mapper>