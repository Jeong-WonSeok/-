<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.oti.thirtyone.dao.ApprovalLineDAO">
	<insert id="insertNewApprovalLine" parameterType="EmpApprovalLine">
		<![CDATA[
			INSERT INTO APPROVAL_LINE(
				apr_line_name, -- 결재선 북마크 이름
				apr_line_seq, -- 결재자 순번
				emp_id, -- 결재선 북마크 소유자 ID
				apr_line_approver -- 결재자 ID
			) VALUES (
				#{aprLineName},
				#{aprLineSeq},
				#{empId},
				#{aprLineApprover}
			)
		]]>
	</insert>
	
	<insert id="insertApprovalLine" parameterType="EmpApprovalLine">
		<![CDATA[
			INSERT INTO APPROVAL_LINE(
				apr_line_name, -- 결재선 북마크 이름
				apr_line_seq, -- 결재자 순번
				emp_id, -- 결재선 북마크 소유자 ID
				apr_line_approver, -- 결재자 ID
				apr_line_index -- 결재선 INDEX
			) VALUES (
				#{aprLineName},
				#{aprLineSeq},
				#{empId},
				#{aprLineApprover},
				#{aprLineIndex}
			)
		]]>
	</insert>
	
	<update id="updateApprovalLine" parameterType="EmpApprovalLine">
		<![CDATA[
			UPDATE APPROVAL_LINE
			SET apr_line_name = #{aprLineName}, -- 결재선 북마크 이름
				apr_line_seq = #{aprLineSeq}, -- 결재자 순번
				apr_line_approver = #{aprLineApprover} -- 결재자 ID
			WHERE 
				emp_id = #{empId} -- 결재선 소유자 id
			END apr_line_index = #{apr_line_index} -- 결재선 인덱스
		]]>
	</update>
	
	<select id="selectApprovalLineByIdx" parameterType="EmpApprovalLine" resultType="EmpApprovalLine">
		<![CDATA[
			SELECT
				apr_line_name,
				apr_line_seq,
				emp_id,
				apr_line_approver,
				apr_line_index
			FROM APPROVAL_LINE
			WHERE 
				emp_id = #{empId}
			AND apr_line_name = #{aprLineName},
			AND apr_line_index <= #{aprLineIndex}
			ORDER BY apr_line_seq
		]]>
	</select>
	
	<delete id="deleteApprovalLine" parameterType="EmpApprovalLine">
		<![CDATA[
			DELETE FROM APPROVAL_LINE
			WHERE
				emp_id = #{empId} -- 결재선 소유자 id
			END apr_line_name = #{apr_line_name} -- 결재선 이름
			END apr_line_index = #{apr_line_index} -- 결재선 인덱스
		]]>
	</delete>
	
	<select id="selectApprovalLineName" parameterType="EmpApprovalLine" resultType="EmpApprovalLine">
		<![CDATA[
			SELECT APR_LINE_NAME
			FROM APPROVAL_LINE
			WHERE 
				emp_id = #{empId}
			AND apr_line_name = #{aprLineName}
		]]>
	</select>
	
	<select id="selectAllApprovalLineByEmpId" parameterType="String" resultType="EmpApprovalLine">
		<![CDATA[
			SELECT
				APR_LINE_NAME,
				APR_LINE_SEQ,
				EMP_ID,
				APR_LINE_APPROVER,
				APR_LINE_INDEX
			FROM APPROVAL_LINE
			WHERE emp_id = #{empId}
			ORDER BY apr_line_index, apr_line_seq
		]]>
	</select>
	
	<select id="selectApprovalLineByPager" parameterType="Pager" resultType="EmpApprovalLine" >
		<![CDATA[
			WITH ApprovalList AS (
			    SELECT
			        DISTINCT APR_LINE_NAME,
			        APR_LINE_INDEX,
			        ROW_NUMBER() OVER (ORDER BY APR_LINE_INDEX) AS rn
			    FROM APPROVAL_LINE
			    WHERE emp_id = #{empId}
			),
			SELECT
				DISTINCT APR_LINE_NAME,
		        APR_LINE_INDEX
			FROM ApprovalList
			WHERE rn BETWEEN #{startRowNo} AND #{endRowNo}
			ORDER BY APR_LINE_INDEX
		]]>
	</select>
	
	<select id="selectCountApprovalLine" parameterType="EmpApprovalLine" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM APPROVAL_LINE
			WHERE
				emp_id = #{empId}
			AND apr_line_name = #{aprLineName}
		]]>
	</select>
</mapper>